{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<h2>Welcome, {{ user }}!</h2>

<!-- Add Task Form -->
<form method="post" class="row g-3">
    <div class="col-md-4">
        <input type="text" name="task" placeholder="Task" class="form-control" required>
    </div>
    <div class="col-md-3">
        <input type="date" name="date" class="form-control" required>
    </div>
    <div class="col-md-2">
        <input type="time" name="start" class="form-control" value="09:00" required>
    </div>
    <div class="col-md-2">
        <input type="time" name="end" class="form-control" value="17:00" required>
    </div>
    <div class="col-md-1">
        <button class="btn btn-success w-100">Add</button>
    </div>
</form>

<hr>

<!-- Tasks Table -->
<table class="table table-striped">
    <thead>
        <tr><th>Date</th><th>Task</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody>
        {% for i, task in enumerate(tasks) %}
        <tr>
            <td>{{ task[1] }}</td>
            <td>
                {{ task[2] }}
                <br>
                {% if task[4] %}
                <img src="{{ url_for('static', filename='uploads/task_0_98029a54-a1d7-4571-9fb4-2da4355126d1.jpg') }}" alt="Task Image">
            {% else %}
                <span>No image available</span>
            {% endif %}
            </td>
            <td>{{ task[3] }}</td>
            <td>
                <!-- Task Actions -->
                <a href="{{ url_for('main.delete_task', task_index=i) }}" class="btn btn-danger btn-sm">Delete</a>
                <a href="{{ url_for('main.send_email', task_index=i) }}" class="btn btn-outline-primary btn-sm">Email</a>
                <a href="#" class="btn btn-info btn-sm" onclick="confirmMarkAsDone({{ i }})">Mark as Done</a>
                <a href="{{ url_for('main.generate_qr', task_index=i) }}" class="btn btn-secondary btn-sm" download>Download QR Code</a>
                <form action="{{ url_for('main.upload_picture') }}" method="post" enctype="multipart/form-data" style="display:inline;">
                    <input type="hidden" name="task_index" value="{{ loop.index0 }}">
                    <input type="file" name="picture" accept="image/*" required>
                    <button type="submit" class="btn btn-warning btn-sm">Add Picture</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Export PDF Button -->
<a href="{{ url_for('main.export_pdf') }}" class="btn btn-secondary">Export PDF</a>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('main.upload_picture') }}">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Picture for Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="task_index" id="modal-task-index">
                    <input type="file" name="picture" class="form-control" accept="image/*" id="fileInput" required onchange="previewImage(event)">
                    
                    <!-- Image Preview -->
                    <div id="imagePreviewContainer" style="margin-top: 10px; display: none;">
                        <img id="imagePreview" src="#" alt="Image Preview" style="max-width: 100%; border-radius: 8px;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Image Modal for Viewing Uploaded Image -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="#" alt="Task Image" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and dependencies (required for modals) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Open Image Modal to view photo
    function openImageModal(imageName) {
        const imageUrl = "{{ url_for('static', filename='uploads/') }}" + imageName;  // Correct image path
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageUrl;  // Set the image source for the modal
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    // Confirm Mark as Done
    function confirmMarkAsDone(taskIndex) {
        const confirmation = confirm("Are you sure you want to mark this task as done?");
        if (confirmation) {
            const url = "{{ url_for('main.mark_as_done', task_index=0) }}".replace("0", taskIndex);
            window.location.href = url;
        }
    }

    // Open Upload Modal
    function openUploadModal(taskIndex) {
        document.getElementById('modal-task-index').value = taskIndex;
        const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
        modal.show();
    }

    // Preview Image Before Upload
    function previewImage(event) {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function() {
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            
            imagePreview.src = reader.result;
            imagePreviewContainer.style.display = 'block'; // Show the preview
        };

        if (file) {
            reader.readAsDataURL(file); // Read the file as a data URL
        }
    }
</script>

{% endblock %}
